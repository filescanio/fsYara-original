name: Push to fsYara

on:
  push:
    branches:
      - STI-*
      - main  # Trigger on pushes to the main branch

jobs:
  update-fsYara-repo:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source Repository
      uses: actions/checkout@v3

    - name: python setup
      uses: actions/setup-python@v3

    # plyara must happen before the pre commit execution 
    - name: Yara installation
      run: |
        mkdir -p .install_yara
        cd .install_yara
        pip3 install plyara
        pip install plyara #! trying pip 
        # python3 -m pip install yara-python
        pip install yara-python
        cd /usr/local/lib
        ls -la
        cat /etc/ld.so.conf
        curl -LO "https://github.com/VirusTotal/yara/archive/refs/tags/v4.5.2.tar.gz"
        ls
        tar -zxf v4.5.2.tar.gz
        ls
        cd yara-4.5.2
        ./bootstrap.sh
        ./configure
        make
        sudo make install

    - name: pre-commit
      uses: pre-commit/action@v3.0.1

    - name: Yara hardening
      run: |
        python3 tools/ci/harden_yara.py . 

    - name: Clone Target Repository
      env:
        TARGET_REPO_URL: https://github.com/filescanio/fsYara-test.git
        TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}
      run: |
        rm -rf target-repo
        git clone https://$TARGET_REPO_PAT@github.com/filescanio/fsYara-test.git target-repo

    - name: Create or Checkout Feature Branch
      run: |
        cd target-repo
        FEATURE_BRANCH="STI-7263-hardened-yara"
        # git pull origin $FEATURE_BRANCH
        git fetch origin $FEATURE_BRANCH
        git checkout $FEATURE_BRANCH

    - name: Commit and Push
      env:
        TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}
      run: |
        find ./target-repo -mindepth 1 ! -regex '^./target-repo/.git\(/.*\)?' -delete
        rsync -av --exclude=".*" --exclude="target-repo" ./ target-repo
        cd target-repo
        FEATURE_BRANCH="STI-7263-hardened-yara"
        git config user.email "zsolt.major@opswat.com"
        git config user.name "zsoltmajoropswat"
        git add .
        git commit -m "Automated update from source repository"
        git push --set-upstream origin $FEATURE_BRANCH